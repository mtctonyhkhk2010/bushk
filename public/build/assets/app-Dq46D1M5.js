typeof navigator.serviceWorker<"u"&&navigator.serviceWorker.register("/sw.js");navigator.permissions.query({name:"geolocation"}).then(e=>{e.state==="granted"?window.watch_position_id=navigator.geolocation.watchPosition(r=>{window.coords=r.coords;const o=new CustomEvent("position-updated");document.dispatchEvent(o)}):(console.log("Browser location services disabled",navigator),navigator.geolocation.getCurrentPosition(()=>{}))},()=>{console.log("Browser permissions services unavailable",navigator)});window.fetchEta=async(e,r,o=null,g=null,p=null,n=null,u=null,m=null,s=null,k=!1)=>{let l,c={},h=[];e==="kmb"&&(l=`https://data.etabus.gov.hk/v1/transport/kmb/eta/${r}/${o}/${g}`),e==="ctb"&&(l=`https://rt.data.gov.hk//v2/transport/citybus/eta/CTB/${r}/${o}`),e==="gmb"&&(l=`https://data.etagmb.gov.hk/eta/route-stop/${p}/${r}`),e==="lrtfeeder"&&(l="https://rt.data.gov.hk/v1/transport/mtr/bus/getSchedule",c.headers={"Content-Type":"application/json"},c.method="POST",c.body=JSON.stringify({routeName:o,language:"zh"})),e==="nlb"&&(l="https://rt.data.gov.hk/v1/transport/nlb/stop.php?action=estimatedArrivals",c.method="POST",c.body=JSON.stringify({routeId:u,stopId:r,language:"zh"})),e==="lightRail"&&(l=`https://rt.data.gov.hk/v1/transport/mtr/lrt/getSchedule?station_id=${r.substring(2)}`),e==="mtr"&&(l=`https://rt.data.gov.hk/v1/transport/mtr/getSchedule.php?line=${o}&sta=${r}`);const v=await fetch(l,c);if(!v.ok)return h;const f=await v.json();if((e==="kmb"||e==="ctb")&&f.data.forEach(t=>{t.eta===""||t.eta===null||t.dir!==n||k&&t.seq!==s+1||h.push({timestamp:Date.parse(t.eta),eta:t.eta,co:t.co,remark:t.rmk_tc})}),e==="gmb"&&f.data.forEach(t=>{n==="I"&&t.route_seq===1||n==="O"&&t.route_seq===2||t.stop_seq===s+1&&t.eta.forEach(a=>{a.timestamp===""||a.timestamp===null||h.push({timestamp:Date.parse(a.timestamp),eta:a.timestamp,co:"gmb",remark:a.remarks_tc})})}),e==="nlb"&&f.estimatedArrivals.forEach(t=>{t.estimatedArrivalTime===""||t.estimatedArrivalTime===null||h.push({timestamp:Date.parse(t.estimatedArrivalTime),eta:t.estimatedArrivalTime,co:"nlb",remark:""})}),e==="lrtfeeder"&&f.busStop.forEach(t=>{t.busStopId===r&&t.bus.forEach(a=>{let i=new Date;const d=a.departureTimeInSecond*1e3;i=new Date(i.getTime()+d),h.push({timestamp:i.getTime(),eta:i.toISOString(),co:"lrtfeeder",remark:""})})}),e==="lightRail"&&f.platform_list.forEach(t=>{t.route_list.forEach(a=>{if(a.route_no!==o||a.dest_ch!==m)return;let i=new Date;const d=/\d/.test(a.time_en)?a.time_en.match(/\d+/)[0]*6e4:0;i=new Date(i.getTime()+d),h.push({timestamp:i.getTime(),eta:i.toISOString(),co:"lightRail",remark:"",plat:a.plat})})}),e==="mtr")for(const t in f.data){const a=f.data[t];n=n.split("-")[n.split("-").length-1];const i=n==="DT"?"DOWN":"UP";a.hasOwnProperty(i)&&a[i].forEach(d=>{h.push({timestamp:Date.parse(d.time),eta:d.time,co:"mtr",remark:"",dest:d.dest,plat:d.plat})})}return h};window.distance=(e,r,o,g)=>{if(e===o&&r===g)return 0;{let p=Math.PI*e/180,n=Math.PI*o/180,u=r-g,m=Math.PI*u/180,s=Math.sin(p)*Math.sin(n)+Math.cos(p)*Math.cos(n)*Math.cos(m);return s>1&&(s=1),s=Math.acos(s),s=s*180/Math.PI,s=s*60*1.1515,s*1.609344}};
